<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:insert="header"></head>

<body>
	<div th:insert="headerImage"></div>

	<div th:insert="navBarTop"></div>
	<div th:insert="headerMessage"></div>

	 <div class="container-fluid header-design-login">
        <div class="row justify-content-center align-items-center" style="height: 10vh;">
            <div class="webland-container">
                <form th:action="@{/fetch-ccrc-crop-data}" method="post" id="weblandForm">
                   <h5 style="color: darkgreen; font-weight: bold;">Data Preparation From CCRC</h5>

                    <br />
                    <!-- Crop Year Dropdown -->
                    <div class="mb-3 form-group">
                        <label for="cropyear">Select Crop Year:</label>
                        <select id="cropyear" name="cropyear" class="form-control custom-select" required>
                            <option value="" disabled selected>Select Crop Year</option>
                            <option th:each="season : ${activeSeasons}" th:value="${season.seasonvalue}"
                                th:text="${season.cropyear}"></option>
                        </select>
                    </div>

                    <!-- Village Dropdown -->
                    <div class="mb-3 form-group">
                        <label for="village">Select Village:</label>
                        <select id="village" name="village" class="form-control custom-select" required>
                            <option value="" disabled selected>Select Village</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block"
                        style="margin-right: 30px;">Download</button>
                    <button type="button" class="btn btn-secondary btn-block" onclick="resetForm()">Refresh</button>

                    <!-- "Please wait" message -->
                    <div id="pleaseWaitMessage" style="display: none;">Please wait while fetching the data...</div>

                    <!-- Display Success Message -->
                    <div th:if="${successMessage}" class="alert alert-success" role="alert">
                        <strong>Success:</strong> <span th:text="${successMessage}"></span> 
                    </div>

                    <!-- Display Error Message -->
                    <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
                        <strong>Error:</strong> <span th:text="${errorMessage}"></span>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" th:src="@{/js/jquery.js}"></script>
    <!-- Include NProgress JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
    <script>
    $(function () {
        // Initial setup
        $('#weblandForm').submit(function (e) {
            // Check if both dropdowns are selected before allowing form submission
            if ($('#cropyear').val() === '' || $('#village').val() === '') {
                alert('Please select both Crop Year and Village.');
                e.preventDefault(); // Prevent form submission
            } else {
                // Display "Please wait" message
                $('#pleaseWaitMessage').show();
                // Start the loading bar on form submission
                NProgress.start();
            }
        });

        $('#cropyear').on('change', function () {
            // Reset Village dropdown
            $('#village').empty().append('<option value="" disabled selected>Select Village</option>');
            // Fetch village list when Crop Year is selected
            if ($('#cropyear').val() !== '') {
                fetchVillageList();
            }
        });

        $('#village').on('change', function () {
            // Reset "Please wait" message and loading bar on Village dropdown change
            $('#pleaseWaitMessage').hide();
            NProgress.done();
        });

        // Additional setup for the "Refresh" button
        $('#weblandForm').find('button[type="button"]').on('click', function () {
            // Hide error message
            $('.alert-danger').hide();
            // Reset Crop Year dropdown
            $('#cropyear').val('');
            // Trigger change event to reset Village dropdown
            $('#cropyear').change();
            // Optionally, you can reset other form fields or perform additional actions here.

            // Populate dropdowns with data (assuming the fetchVillageList function is also used during initial setup)
            fetchVillageList();
        });
    });

    function fetchVillageList() {
        $.ajax({
            url: './rest/api/Ccrc-Crop/villages',
            method: 'GET',
            data: { activeSeason: $('#cropyear').val() },
            dataType: 'json',
            beforeSend: function () {
                // Loading bar before the request is sent
            },
            success: function (response) {
                var data = response;
                var str = '<option value="">Select Village</option>';
                $.each(data, function (index, obj) {
                    str += '<option value="' + obj.wbvcode + '">' + obj.wbvname + '</option>';
                });
                $('#village').html(str);
            },
            error: function (xhr, status, error) {
                // Handle the error as needed
            },
            complete: function () {
                // Loading bar complete after the request is done
                NProgress.done();
                // Hide "Please wait" message
                $('#pleaseWaitMessage').hide();
            }
        });
    }
</script>
</body>

</html>